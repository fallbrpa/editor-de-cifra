<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Editor de Cifra</title>
<style>
  :root {
    --bg-color: #ffffff;
    --text-color: #000000;
    --chord-color: #e53935;
    --bar-color: red;
    --border-color: #ccc;
  }

  body.dark-mode {
    --bg-color: #121212;
    --text-color: #f0f0f0;
    --chord-color: #ff5c5c;
    --bar-color: #ff5c5c;
    --border-color: #444;
  }

  body {
    font-family: Arial, sans-serif;
    margin: 20px;
    background-color: var(--bg-color);
    color: var(--text-color);
    transition: background-color 0.3s ease, color 0.3s ease;
  }

  .container {
    display: flex;
    flex-direction: row;
    gap: 20px;
    transition: all 0.3s ease;
  }

  .vertical {
    flex-direction: column;
  }

  textarea {
    width: 100%;
    height: 300px;
    background-color: var(--bg-color);
    color: var(--text-color);
    border: 1px solid var(--border-color);
    padding: 10px;
    border-radius: 6px;
    font-family: monospace;
  }

  .editor, .preview {
    flex: 1;
  }

  .editor {
    margin-right: 20px;
  }

  #previewArea {
    font-family: monospace;
    white-space: pre;
    line-height: 1.4;
    background-color: var(--bg-color);
    color: var(--text-color);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    padding: 10px;
    min-height: 300px;
  }

  .bar {
    color: var(--bar-color);
    font-weight: bold;
    display: inline-block;
    width: 1ch;
    text-align: center;
  }

  .chord {
    color: var(--chord-color);
    font-weight: bold;
    display: inline-block;
    text-align: center;
  }

  .line {
    white-space: pre;
    font-family: monospace;
  }

  button {
    margin-right: 10px;
    padding: 5px 10px;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    background-color: var(--bg-color);
    color: var(--text-color);
    cursor: pointer;
    transition: all 0.3s ease;
  }

  button:hover {
    background-color: var(--border-color);
  }

  h2, h4 {
    margin-top: 0;
  }

  @media (max-width: 768px) {
    .container {
      flex-direction: column;
    }
  }

  /* Dropdown para inserir acordes */
  .dropdown {
    position: relative;
    display: inline-block;
  }

  .dropdown-content {
    display: none;
    position: absolute;
    background-color: var(--bg-color);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    z-index: 10;
    margin-top: 5px;
  }

  .dropdown-content button.option {
    display: block;
    width: 100%;
    text-align: left;
    background: none;
    border: none;
    padding: 8px 12px;
    cursor: pointer;
    color: var(--text-color);
  }

  .dropdown-content button.option:hover {
    background-color: var(--border-color);
  }

  .dropdown.show .dropdown-content {
    display: block;
  }
</style>
</head>
<body>
  <h2>Editor de Cifra</h2>

  <div>
    <button id="toggleButtonMenu">Mostrar/Esconder bot√µes extras</button>
    <div id="extraButtons" style="display: none;">
      <button id="transposeUp">Transpor +1</button>
      <button id="transposeDown">Transpor -1</button>
      <button id="toggleLayout">Alternar visualiza√ß√£o</button>
      <button id="toggleTheme">Alternar tema</button>
      <button id="exportTxt">Exportar TXT</button>
      <button id="exportJson">Exportar JSON</button>
      <button id="importFile">Importar</button>
    </div>
    <div class="dropdown">
      <button id="insertChord">Inserir acorde</button>
      <div id="chordMenu" class="dropdown-content">
        <button class="option" data-chord="[C]">Acorde normal [C]</button>
        <button class="option" data-chord="[|C]">Acorde com barra [|C]</button>
        <button class="option" data-chord="[ C]">Acorde de introdu√ß√£o [ C]</button>
      </div>
    </div>
    <input type="file" id="fileInput" accept=".txt,.json" style="display:none" />
    <p><small>Editor de Cifras v1.0</small></p>
  </div>

  <div id="mainContainer" class="container">
    <div class="editor">
      <h4>Editor</h4>
      <textarea id="inputArea" placeholder="Digite sua cifra aqui..."></textarea>
    </div>
    <div class="preview">
      <h4>Preview</h4>
      <div id="previewArea"></div>
    </div>
  </div>

<script>
  const inputArea = document.getElementById("inputArea");
  const previewArea = document.getElementById("previewArea");
  const insertChord = document.getElementById("insertChord");
  const toggleLayout = document.getElementById("toggleLayout");
  const toggleTheme = document.getElementById("toggleTheme");
  const transposeUp = document.getElementById("transposeUp");
  const transposeDown = document.getElementById("transposeDown");
  const exportTxt = document.getElementById("exportTxt");
  const exportJson = document.getElementById("exportJson");
  const importFile = document.getElementById("importFile");
  const fileInput = document.getElementById("fileInput");
  const container = document.getElementById("mainContainer");
  const chordMenu = document.getElementById("chordMenu");
  const dropdown = document.querySelector(".dropdown");

  const notes = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];

  // ====== üîπ Salvar e carregar estado ======
  function saveState() {
    localStorage.setItem("cifraTheme", document.body.classList.contains("dark-mode"));
    localStorage.setItem("cifraLayout", container.classList.contains("vertical"));
  }

  function loadState() {
    const dark = localStorage.getItem("cifraTheme") === "true";
    const vertical = localStorage.getItem("cifraLayout") === "true";
    if (dark) document.body.classList.add("dark-mode");
    if (vertical) container.classList.add("vertical");
  }

  // ====== Inicializa√ß√£o ======
  loadState();

  inputArea.addEventListener("input", updatePreview);
  toggleLayout.addEventListener("click", () => {
    container.classList.toggle("vertical");
    saveState();
  });
  toggleTheme.addEventListener("click", () => {
    document.body.classList.toggle("dark-mode");
    saveState();
  });

  // ====== Menu de acordes ======
  insertChord.addEventListener("click", (e) => {
    e.stopPropagation();
    dropdown.classList.toggle("show");
  });

  document.querySelectorAll(".dropdown-content .option").forEach(btn => {
    btn.addEventListener("click", (e) => {
      const chord = e.target.getAttribute("data-chord");
      insertAtCursor(inputArea, chord);
      updatePreview();
      dropdown.classList.remove("show");
    });
  });

  document.addEventListener("click", () => dropdown.classList.remove("show"));

  function insertAtCursor(field, value) {
    const start = field.selectionStart;
    const end = field.selectionEnd;
    field.value = field.value.substring(0, start) + value + field.value.substring(end);
    field.focus();
    field.selectionStart = field.selectionEnd = start + value.length;
  }

  // ====== Transposi√ß√£o ======
  function transposeChord(chord, step) {
    const regex = /^([A-G](#|b)?)(.*)$/;
    const match = chord.match(regex);
    if (!match) return chord;

    let root = match[1];
    let suffix = match[3] || "";

    const flatMap = { "Db":"C#", "Eb":"D#", "Gb":"F#", "Ab":"G#", "Bb":"A#" };
    if (flatMap[root]) root = flatMap[root];

    let index = notes.indexOf(root);
    if (index === -1) return chord;

    let newIndex = (index + step + notes.length) % notes.length;
    return notes[newIndex] + suffix;
  }

  function transposeText(text, step) {
    return text.replace(/\[([^\]]+)\]/g, (match, chord) => {
      let prefix = chord[0] === "|" || chord[0] === " " ? chord[0] : "";
      chord = prefix ? chord.slice(1) : chord;
      return `[${prefix}${transposeChord(chord, step)}]`;
    });
  }

  transposeUp.addEventListener("click", () => {
    inputArea.value = transposeText(inputArea.value, 1);
    updatePreview();
  });

  transposeDown.addEventListener("click", () => {
    inputArea.value = transposeText(inputArea.value, -1);
    updatePreview();
  });

  // ====== Renderiza√ß√£o ======
  function updatePreview() {
    const text = inputArea.value;
    const lines = text.split("\n");
    let html = "";

    lines.forEach(line => {
      let chordLine = "";
      let lyricLine = "";
      let chordActive = false;
      let chordBuffer = "";
      let chordSkipper = 0

      for (let i = 0; i < line.length; i++) {
        const ch = line[i];

        if (ch === "[" && !chordActive) {
          chordActive = true;
          chordBuffer = "";
        } else if (ch === "]" && chordActive) {
          chordActive = false;

          if (chordBuffer.startsWith("|")) {
            const core = chordBuffer.slice(1);
            chordSkipper = core.length - 1;
            chordLine += `<span class="chord">${escapeHtml(core)}</span>`;
            lyricLine += `<span class="bar">|</span>`;
          } else if (chordBuffer.startsWith(" ")) {
            const core = chordBuffer.slice(1);
            chordLine += "&nbsp;".repeat(core.length);
            lyricLine += `<span class="chord">${escapeHtml(core)}</span>`;
          } else {
            chordSkipper = chordBuffer.length;
            chordLine += `<span class="chord">${escapeHtml(chordBuffer)}</span>`;
            // lyricLine += "&nbsp;".repeat(chordBuffer.length);
          }

        } else if (chordActive) {
          chordBuffer += ch;
        } else {
          if(chordSkipper === 0) {
            chordLine += "&nbsp;";
          } else {
            chordSkipper--;
          }
          lyricLine += (ch === " ") ? "&nbsp;" : escapeHtml(ch);
        }
      }

      html += `<div class="line">${chordLine}<br>${lyricLine}</div>`;
    });

    previewArea.innerHTML = html;
  }

  function escapeHtml(str) {
    return String(str).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
  }

  // ====== Exportar / Importar ======
  function downloadFile(blob, filename) {
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    a.click();
    URL.revokeObjectURL(a.href);
  }

  exportTxt.addEventListener("click", () => {
    const blob = new Blob([inputArea.value], { type: "text/plain" });
    downloadFile(blob, "cifra.txt");
  });

  exportJson.addEventListener("click", () => {
    const data = { cifra: inputArea.value };
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
    downloadFile(blob, "cifra.json");
  });

  importFile.addEventListener("click", () => fileInput.click());

  fileInput.addEventListener("change", (event) => {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
      const content = e.target.result;
      if (file.name.endsWith(".json")) {
        try {
          const data = JSON.parse(content);
          inputArea.value = data.cifra || "";
        } catch {
          alert("Arquivo JSON inv√°lido!");
        }
      } else {
        inputArea.value = content;
      }
      updatePreview();
    };
    reader.readAsText(file);
  });

  // ====== Atalhos ======
  document.addEventListener("keydown", (e) => {
    if (e.ctrlKey) {
      switch (e.key) {
        case "1": e.preventDefault(); insertAtCursor(inputArea, "[C]"); break;
        case "2": e.preventDefault(); insertAtCursor(inputArea, "[|C]"); break;
        case "3": e.preventDefault(); insertAtCursor(inputArea, "[ C]"); break;
        case "ArrowUp": e.preventDefault(); inputArea.value = transposeText(inputArea.value, 1); break;
        case "ArrowDown": e.preventDefault(); inputArea.value = transposeText(inputArea.value, -1); break;
      }
      updatePreview();
    }
  });

  updatePreview();
</script>
</body>
</html>
